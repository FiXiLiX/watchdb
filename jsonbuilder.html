<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Watch JSON Editor</title>
<style>
body { background: #121212; color: #eee; font-family: Arial, sans-serif; margin: 20px; }
h2 { color: #fff; margin-bottom: 10px; }
label { font-weight: bold; display: block; margin-bottom: 5px; }
input, textarea {
    background: #1e1e1e; color: #fff; border: 1px solid #444;
    border-radius: 6px; padding: 10px; margin-bottom: 12px; width: 100%;
    box-sizing: border-box;
}
textarea { height: 70px; font-family: monospace; }
.btn {
    background: #333; color: #fff; border: none;
    padding: 8px 16px; margin: 5px; border-radius: 6px;
    cursor: pointer; transition: 0.2s;
}
.btn:hover { background: #555; }
.row { display: flex; gap: 10px; }
.row .field { flex: 1; }
#formArea { margin-top: 20px; }
#notification {
    margin-top: 10px; padding: 10px 15px; border-radius: 6px; display: none;
}
#notification.success { background-color: #28a745; color: #fff; }
#notification.error { background-color: #dc3545; color: #fff; }
.image-preview { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
.image-preview img {
    width: 180px; height: 180px; object-fit: cover; cursor: pointer;
    border: 2px solid #444; border-radius: 6px; transition: 0.2s;
}
.image-preview img:hover { transform: scale(1.05); border-color: #888; }
#imagePopup {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.85); justify-content:center; align-items:center;
    z-index: 1000; flex-direction: column;
}
#imagePopup img { max-width:80%; max-height:80%; border-radius:6px; margin-bottom:10px; }
#popupClose { color:#fff; cursor:pointer; font-size:24px; margin-bottom:10px; }
#topButtons { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px; }
#watchSuggestions { position:absolute; z-index:100; background:#1e1e1e; border:1px solid #444; width:100%; max-height:200px; overflow-y:auto; border-radius:6px; }
#watchSuggestions div { padding:5px 10px; cursor:pointer; }
#watchSuggestions div:hover { background:#333; }
</style>
</head>
<body>

<h2>Watch JSON Editor</h2>

<!-- Top buttons -->
<div id="topButtons">
  <button class="btn" id="openFileBtn">üìÇ Open JSON File</button>
  <button class="btn" id="setDefaultBtn" style="display:none;">‚≠ê Set as Default</button>
  <button class="btn" id="addWatchBtn" style="display:none;">‚ûï Add Watch</button>
  <button class="btn" id="saveWatchBtn">üíæ Save Watch</button>
  <button class="btn" id="deleteWatchBtn" style="background:#922;">üóë Delete Watch</button>
</div>

<div id="notification"></div>

<label for="watchSearch">Select Watch:</label>
<input id="watchSearch" type="text" placeholder="Type to search...">
<div id="watchSuggestions"></div>

<div id="formArea" style="display:none;">
  <div class="row">
    <div class="field"><label>Name:</label><input id="name" type="text"></div>
    <div class="field"><label>Color:</label><input id="color" type="text"></div>
    <div class="field"><label>Case Size:</label><input id="case_size" type="text"></div>
  </div>
  <div class="row">
    <div class="field"><label>Movement:</label><input id="movement" type="text"></div>
    <div class="field"><label>Country:</label><input id="country" type="text"></div>
    <div class="field"><label>Price:</label><input id="price" type="text"></div>
  </div>
  <label>Description:</label>
  <textarea id="description"></textarea>

  <label>Bracelet:</label>
  <input id="bracelet" type="text">

  <label>Images (comma separated URLs):</label>
  <textarea id="images"></textarea>
  <div class="image-preview" id="imagePreview"></div>
</div>

<!-- Image popup -->
<div id="imagePopup">
  <div id="popupClose">‚úñ Close</div>
  <img id="popupImg" src="">
</div>

<script>
let watches = {};
let currentKey = null;
let fileHandle = null;
let popupIndex = 0;
const fields = ["name","color","case_size","movement","country","description","price","bracelet","images"];

const watchSearch = document.getElementById("watchSearch");
const suggestionsDiv = document.getElementById("watchSuggestions");
const formArea = document.getElementById("formArea");
const notification = document.getElementById("notification");
const popup = document.getElementById("imagePopup");
const popupImg = document.getElementById("popupImg");

function showNotification(msg, type="success") {
  notification.textContent = msg;
  notification.className = type === "success" ? "success" : "error";
  notification.style.display = "block";
  setTimeout(() => { notification.style.display = "none"; }, 3000);
}

function populateDropdown() {
  // Not needed for autocomplete, used to refresh watchSearch suggestions
  watchSearch.value = "";
  suggestionsDiv.innerHTML = "";
}

function loadWatch(key) {
  currentKey = key;
  const watch = watches[key];
  if (!watch) return;

  fields.forEach(f => {
    if(f==="images") document.getElementById(f).value = (watch[f] || []).join(", ");
    else document.getElementById(f).value = watch[f] || "";
  });
  renderImagePreview(watch.images || []);
}

function renderImagePreview(urls) {
  const preview = document.getElementById("imagePreview");
  preview.innerHTML = "";
  urls.forEach((url,i) => {
    const img = document.createElement("img");
    img.src = url;
    img.onclick = () => openPopup(i);
    preview.appendChild(img);
  });
}

function openPopup(index) {
  const urls = watches[currentKey].images || [];
  if (!urls.length) return;
  popupIndex = index;
  popupImg.src = urls[popupIndex];
  popup.style.display = "flex";
}

document.addEventListener("keydown", e => {
  if (popup.style.display !== "flex") return;
  const urls = watches[currentKey].images || [];
  if (e.key === "ArrowRight") {
    popupIndex = (popupIndex + 1) % urls.length;
    popupImg.src = urls[popupIndex];
  } else if (e.key === "ArrowLeft") {
    popupIndex = (popupIndex - 1 + urls.length) % urls.length;
    popupImg.src = urls[popupIndex];
  } else if (e.key === "Escape") {
    popup.style.display = "none";
  }
});

document.getElementById("popupClose").onclick = () => popup.style.display = "none";

async function openJsonFile() {
  [fileHandle] = await window.showOpenFilePicker({
    types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }]
  });
  await loadJsonFile();
  document.getElementById("setDefaultBtn").style.display = "inline-block";
}

async function loadJsonFile() {
  const file = await fileHandle.getFile();
  const text = await file.text();
  watches = JSON.parse(text);
  populateDropdown();
  formArea.style.display = "block";
  document.getElementById("addWatchBtn").style.display = "inline-block";
  loadWatch(Object.keys(watches)[0]);
}

async function saveJsonFile() {
  if (!fileHandle) return;
  const writable = await fileHandle.createWritable();
  await writable.write(JSON.stringify(watches,null,4));
  await writable.close();
}

// Save watch
document.getElementById("saveWatchBtn").addEventListener("click", async () => {
  if (!fileHandle) return showNotification("No file loaded!", "error");
  let key = currentKey;
  if (!key) key = prompt("Enter a unique key for this watch:");
  if (!key) return showNotification("Watch key is required!", "error");

  const updated = {};
  fields.forEach(f => {
    if(f==="images") updated[f] = document.getElementById(f).value.split(",").map(s=>s.trim()).filter(Boolean);
    else updated[f] = document.getElementById(f).value;
  });
  watches[key] = updated;
  populateDropdown();
  currentKey = key;
  loadWatch(key);
  await saveJsonFile();
  showNotification("Watch saved and file updated!");
});

// Add new watch
document.getElementById("addWatchBtn").addEventListener("click", () => {
  currentKey = null;
  watchSearch.value = "";
  suggestionsDiv.innerHTML = "";
  fields.forEach(f => document.getElementById(f).value = "");
  document.getElementById("imagePreview").innerHTML = "";
  showNotification("Fill in the form and click Save Watch to add.");
});

// Delete watch
document.getElementById("deleteWatchBtn").addEventListener("click", async () => {
  if (!currentKey) return showNotification("No watch selected to delete.", "error");
  if (confirm(`Are you sure you want to delete '${currentKey}'?`)) {
    delete watches[currentKey];
    populateDropdown();
    if (Object.keys(watches).length) loadWatch(Object.keys(watches)[0]);
    else formArea.style.display = "none";
    currentKey = Object.keys(watches)[0] || null;
    await saveJsonFile();
    showNotification("Watch deleted and file updated!");
  }
});

// Autocomplete search
watchSearch.addEventListener("input", () => {
  const query = watchSearch.value.toLowerCase();
  const matches = Object.keys(watches).filter(k=>k.toLowerCase().includes(query));
  suggestionsDiv.innerHTML = "";
  matches.forEach(match => {
    const div = document.createElement("div");
    div.textContent = match;
    div.onclick = () => { watchSearch.value = match; loadWatch(match); suggestionsDiv.innerHTML=""; };
    suggestionsDiv.appendChild(div);
  });
});

document.addEventListener("click", e => {
  if (!watchSearch.contains(e.target) && !suggestionsDiv.contains(e.target)) suggestionsDiv.innerHTML="";
});

// Set default file
document.getElementById("setDefaultBtn").addEventListener("click", async () => {
  if (!fileHandle) return;
  const dbRequest = indexedDB.open("watch-editor",1);
  dbRequest.onupgradeneeded = ()=> dbRequest.result.createObjectStore("handles");
  dbRequest.onsuccess = ()=> {
    const db = dbRequest.result;
    const tx = db.transaction("handles","readwrite");
    tx.objectStore("handles").put(fileHandle,"defaultFile");
    tx.oncomplete = ()=> showNotification("Default file set! Will auto-load next session.");
  };
});

// Auto-load default file
window.addEventListener("DOMContentLoaded", async () => {
  const dbRequest = indexedDB.open("watch-editor",1);
  dbRequest.onupgradeneeded = ()=> dbRequest.result.createObjectStore("handles");
  dbRequest.onsuccess = async ()=> {
    const db = dbRequest.result;
    const tx = db.transaction("handles","readonly");
    const store = tx.objectStore("handles");
    const getReq = store.get("defaultFile");
    getReq.onsuccess = async ()=> {
      const handle = getReq.result;
      if(handle){ fileHandle = handle; try { await loadJsonFile(); document.getElementById("setDefaultBtn").style.display = "inline-block"; } catch(e){console.log(e);} }
    };
  };
});

document.getElementById("openFileBtn").addEventListener("click", openJsonFile);
</script>
</body>
</html>
